# ä¿®å¤filterå¯¼å…¥é—®é¢˜çš„å®Œæ•´AAåˆ†è´¦ç³»ç»Ÿæ’ä»¶
# æ‰€æœ‰æŒ‡ä»¤å·²æ”¹ä¸ºä¸­æ–‡ï¼Œä¸”ä¿®å¤äº†'filteræ¨¡å—ä¸å¯è°ƒç”¨'çš„é”™è¯¯

# å…³é”®ä¿®å¤ï¼šä»filteræ¨¡å—ä¸­å¯¼å…¥filterè£…é¥°å™¨ï¼ˆè€Œéå¯¼å…¥æ¨¡å—æœ¬èº«ï¼‰
from astrbot.api.event.filter import filter
from astrbot.api.event import AstrMessageEvent, MessageEventResult
from astrbot.api.star import Context, Star, register
from astrbot.api import logger
from typing import Dict, List, Optional
import json
import os
import time
import uuid
from datetime import datetime


@register(
    "aaåˆ†è´¦ç³»ç»Ÿ",  # æ’ä»¶å”¯ä¸€æ ‡è¯†ï¼ˆä¸­æ–‡ï¼‰
    "anchor",     # æ’ä»¶ä½œè€…
    "ç®€æ˜“AAåˆ†è´¦ç³»ç»Ÿï¼ˆæ”¯æŒåˆ›å»ºè´¦å•ã€æŸ¥çœ‹è´¦å•ã€å¯¹è´¦æ˜ç»†ã€æ ‡è®°æ¸…è´¦ï¼‰",  # æ’ä»¶æè¿°
    "1.0.1"       # ç‰ˆæœ¬å·ï¼ˆä¿®å¤åç‰ˆæœ¬ï¼‰
)
class AASettlementPlugin(Star):
    def __init__(self, context: Context):
        """æ’ä»¶åˆå§‹åŒ–ï¼šåŠ è½½æ•°æ®ç»“æ„ä¸æŒä¹…åŒ–è·¯å¾„"""
        super().__init__(context)
        # æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆæŒ‰ç”¨æˆ·IDéš”ç¦»è´¦å•ï¼‰
        self.aa_bills: Dict[str, List[Dict]] = {}  # {ç”¨æˆ·ID: [è´¦å•åˆ—è¡¨]}
        self.settlement_records: Dict[str, List[Dict]] = {}  # {ç”¨æˆ·ID: [æ¸…è´¦è®°å½•]}
        # æ•°æ®æŒä¹…åŒ–è·¯å¾„ï¼ˆæ’ä»¶æ‰€åœ¨ç›®å½•ï¼‰
        self.bills_path = os.path.join(os.path.dirname(__file__), "aaè´¦å•æ•°æ®.json")
        self.records_path = os.path.join(os.path.dirname(__file__), "aaæ¸…è´¦è®°å½•.json")
        # åŠ è½½å†å²æ•°æ®
        self._åŠ è½½å†å²æ•°æ®()

    async def initialize(self):
        """å¼‚æ­¥åˆå§‹åŒ–æ–¹æ³•ï¼ˆæ¡†æ¶è‡ªåŠ¨è°ƒç”¨ï¼‰"""
        logger.info("AAåˆ†è´¦ç³»ç»Ÿæ’ä»¶åˆå§‹åŒ–å®Œæˆï¼Œå·²åŠ è½½å†å²è´¦å•æ•°æ®")

    # ---------------------- æŒ‡ä»¤1ï¼šåˆ›å»ºè´¦å•ï¼ˆä¸­æ–‡æŒ‡ä»¤ï¼š/åˆ›å»ºè´¦å•ï¼‰ ----------------------
    @filter.command("åˆ›å»ºè´¦å•")
    async def åˆ›å»ºè´¦å•(self, event: AstrMessageEvent):
        """
        åˆ›å»ºAAè´¦å•
        ç”¨æ³•ï¼š/åˆ›å»ºè´¦å• [å‚ä¸äºº1] [å‚ä¸äºº2] ... [é‡‘é¢] [æè¿°å¯é€‰]
        ç¤ºä¾‹1ï¼š/åˆ›å»ºè´¦å• é™ˆ 100ï¼ˆ1äººå‚ä¸ï¼Œé»˜è®¤æè¿°â€œæ—¥å¸¸æ¶ˆè´¹â€ï¼‰
        ç¤ºä¾‹2ï¼š/åˆ›å»ºè´¦å• å¼ ä¸‰ æå›› 600 èšé¤ï¼ˆ2äººå‚ä¸ï¼Œæè¿°â€œèšé¤â€ï¼‰
        """
        # è·å–ç”¨æˆ·è¾“å…¥çš„çº¯æ–‡æœ¬æ¶ˆæ¯
        æ¶ˆæ¯å†…å®¹ = event.message_str.strip()
        # è§£ææŒ‡ä»¤å‚æ•°ï¼ˆå»é™¤ "/åˆ›å»ºè´¦å•" å‰ç¼€ï¼‰
        å‚æ•°åˆ—è¡¨ = list(filter(None, æ¶ˆæ¯å†…å®¹.split(" ")))[1:]  # å‰1ä¸ªå…ƒç´ æ˜¯ "/åˆ›å»ºè´¦å•"

        # åŸºç¡€å‚æ•°æ ¡éªŒ
        if len(å‚æ•°åˆ—è¡¨) < 2:
            yield event.plain_result(
                "âŒ æŒ‡ä»¤æ ¼å¼é”™è¯¯ï¼æ­£ç¡®ç”¨æ³•ï¼š\n"
                "ğŸ“Œ ç®€å•æ¨¡å¼ï¼š/åˆ›å»ºè´¦å• [å‚ä¸äºº] [é‡‘é¢]ï¼ˆç¤ºä¾‹ï¼š/åˆ›å»ºè´¦å• é™ˆ 100ï¼‰\n"
                "ğŸ“Œ å®Œæ•´æ¨¡å¼ï¼š/åˆ›å»ºè´¦å• [å‚ä¸äºº1] [å‚ä¸äºº2] ... [é‡‘é¢] [æè¿°]ï¼ˆç¤ºä¾‹ï¼š/åˆ›å»ºè´¦å• å¼ ä¸‰ æå›› 600 èšé¤ï¼‰"
            )
            return

        # è§£æé‡‘é¢ï¼ˆä»åå¾€å‰æ‰¾ç¬¬ä¸€ä¸ªæ•°å­—ï¼‰
        æ€»é‡‘é¢ = None
        é‡‘é¢ç´¢å¼• = -1
        for ç´¢å¼• in reversed(range(len(å‚æ•°åˆ—è¡¨))):
            try:
                æ€»é‡‘é¢ = float(å‚æ•°åˆ—è¡¨[ç´¢å¼•])
                é‡‘é¢ç´¢å¼• = ç´¢å¼•
                break
            except ValueError:
                continue

        # é‡‘é¢åˆæ³•æ€§æ ¡éªŒ
        if æ€»é‡‘é¢ is None or æ€»é‡‘é¢ <= 0:
            yield event.plain_result("âŒ é‡‘é¢é”™è¯¯ï¼è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•°ï¼ˆæ”¯æŒå°æ•°ï¼Œå¦‚25.5ï¼‰")
            return

        # æå–å‚ä¸äººã€æè¿°ã€ä»˜æ¬¾äººä¿¡æ¯
        å‚ä¸äººåˆ—è¡¨ = å‚æ•°åˆ—è¡¨[:é‡‘é¢ç´¢å¼•]
        æ¶ˆè´¹æè¿° = " ".join(å‚æ•°åˆ—è¡¨[é‡‘é¢ç´¢å¼•+1:]) if (é‡‘é¢ç´¢å¼• + 1 < len(å‚æ•°åˆ—è¡¨)) else "æ—¥å¸¸æ¶ˆè´¹"
        ä»˜æ¬¾äººID = event.get_sender_id()
        ä»˜æ¬¾äººåç§° = event.get_sender_name() or f"ç”¨æˆ·{ä»˜æ¬¾äººID[:4]}"

        # è¡¥å……ä»˜æ¬¾äººåˆ°å‚ä¸äººåˆ—è¡¨å¹¶å»é‡
        if ä»˜æ¬¾äººåç§° not in å‚ä¸äººåˆ—è¡¨:
            å‚ä¸äººåˆ—è¡¨.append(ä»˜æ¬¾äººåç§°)
        å‚ä¸äººåˆ—è¡¨ = list(set(å‚ä¸äººåˆ—è¡¨))
        å‚ä¸äººæ•° = len(å‚ä¸äººåˆ—è¡¨)

        # è®¡ç®—åˆ†æ‘Šé‡‘é¢ä¸åˆ†è´¦è¯¯å·®
        æ¯äººåˆ†æ‘Š = round(æ€»é‡‘é¢ / å‚ä¸äººæ•°, 2)
        åˆ†è´¦è¯¯å·® = round(æ€»é‡‘é¢ - (æ¯äººåˆ†æ‘Š * å‚ä¸äººæ•°), 2)

        # ç”Ÿæˆè´¦å•ä¿¡æ¯
        è´¦å•ID = str(uuid.uuid4())[:6]
        åˆ›å»ºæ—¶é—´ = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        æ—¶é—´æˆ³ = int(time.time())

        è´¦å•ä¿¡æ¯ = {
            "è´¦å•ID": è´¦å•ID,
            "ä»˜æ¬¾äºº": {"ID": ä»˜æ¬¾äººID, "åç§°": ä»˜æ¬¾äººåç§°},
            "æ€»é‡‘é¢": round(æ€»é‡‘é¢, 2),
            "æ¶ˆè´¹æè¿°": æ¶ˆè´¹æè¿°,
            "å‚ä¸äºº": å‚ä¸äººåˆ—è¡¨,
            "å‚ä¸äººæ•°": å‚ä¸äººæ•°,
            "æ¯äººåˆ†æ‘Š": æ¯äººåˆ†æ‘Š,
            "åˆ†è´¦è¯¯å·®": åˆ†è´¦è¯¯å·®,
            "çŠ¶æ€": "å¾…æ¸…è´¦",
            "åˆ›å»ºæ—¶é—´": åˆ›å»ºæ—¶é—´,
            "æ—¶é—´æˆ³": æ—¶é—´æˆ³,
            "æ¸…è´¦æ—¶é—´": None,
            "æ¸…è´¦äºº": None,
            "å€ºåŠ¡å…³ç³»": self._ç”Ÿæˆå€ºåŠ¡å…³ç³»(ä»˜æ¬¾äººåç§°, å‚ä¸äººåˆ—è¡¨, æ¯äººåˆ†æ‘Š)
        }

        # ä¿å­˜è´¦å•
        self.aa_bills.setdefault(ä»˜æ¬¾äººID, []).append(è´¦å•ä¿¡æ¯)
        self._ä¿å­˜æ•°æ®()

        # ç”Ÿæˆå›å¤
        å›å¤å†…å®¹ = (
            "âœ… AAè´¦å•åˆ›å»ºæˆåŠŸï¼\n"
            "=" * 40 + "\n"
            f"ğŸ†” è´¦å•IDï¼š{è´¦å•ID}ï¼ˆç”¨äºå¯¹è´¦/æ¸…è´¦ï¼‰\n"
            f"ğŸ’¸ ä»˜æ¬¾äººï¼š{ä»˜æ¬¾äººåç§°}\n"
            f"ğŸ“ æ¶ˆè´¹æè¿°ï¼š{æ¶ˆè´¹æè¿°}\n"
            f"ğŸ’° æ€»é‡‘é¢ï¼š{è´¦å•ä¿¡æ¯['æ€»é‡‘é¢']}å…ƒ\n"
            f"ğŸ‘¥ å‚ä¸äººï¼ˆ{å‚ä¸äººæ•°}äººï¼‰ï¼š{', '.join(å‚ä¸äººåˆ—è¡¨)}\n"
            f"ğŸ§® æ¯äººåˆ†æ‘Šï¼š{æ¯äººåˆ†æ‘Š}å…ƒ\n"
        )
        if åˆ†è´¦è¯¯å·® > 0:
            å›å¤å†…å®¹ += f"âš ï¸  åˆ†è´¦è¯¯å·®ï¼š{ä»˜æ¬¾äººåç§°}å¤šæ‰¿æ‹…{åˆ†è´¦è¯¯å·®}å…ƒ\n"
        å›å¤å†…å®¹ += (
            f"â° åˆ›å»ºæ—¶é—´ï¼š{åˆ›å»ºæ—¶é—´}\n"
            "=" * 40 + "\n"
            "ğŸ’¡ åç»­æ“ä½œï¼š\n"
            "  æŸ¥çœ‹æ‰€æœ‰è´¦å•ï¼š/æŸ¥çœ‹è´¦å•\n"
            f"  æŸ¥çœ‹å€ºåŠ¡æ˜ç»†ï¼š/å¯¹è´¦æ˜ç»† {è´¦å•ID}\n"
            f"  æ ‡è®°æ¸…è´¦ï¼š/æ ‡è®°æ¸…è´¦ {è´¦å•ID}"
        )
        yield event.plain_result(å›å¤å†…å®¹)

    # ---------------------- æŒ‡ä»¤2ï¼šæŸ¥çœ‹è´¦å•ï¼ˆä¸­æ–‡æŒ‡ä»¤ï¼š/æŸ¥çœ‹è´¦å•ï¼‰ ----------------------
    @filter.command("æŸ¥çœ‹è´¦å•")
    async def æŸ¥çœ‹è´¦å•(self, event: AstrMessageEvent):
        """
        æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„æ‰€æœ‰AAè´¦å•
        ç”¨æ³•ï¼š/æŸ¥çœ‹è´¦å•
        åŠŸèƒ½ï¼šæŒ‰åˆ›å»ºæ—¶é—´å€’åºæ˜¾ç¤ºï¼ŒåŒºåˆ†å¾…æ¸…è´¦/å·²æ¸…è´¦çŠ¶æ€
        """
        ç”¨æˆ·ID = event.get_sender_id()
        ç”¨æˆ·è´¦å•åˆ—è¡¨ = self.aa_bills.get(ç”¨æˆ·ID, [])

        if not ç”¨æˆ·è´¦å•åˆ—è¡¨:
            yield event.plain_result(
                "ğŸ“‹ æš‚æ— AAè´¦å•\n"
                "ğŸ’¡ å¿«é€Ÿåˆ›å»ºï¼š/åˆ›å»ºè´¦å• [å‚ä¸äºº] [é‡‘é¢]ï¼ˆç¤ºä¾‹ï¼š/åˆ›å»ºè´¦å• é™ˆ 100ï¼‰"
            )
            return

        # æ’åºå¹¶ç»Ÿè®¡çŠ¶æ€
        æ’åºåçš„è´¦å• = sorted(ç”¨æˆ·è´¦å•åˆ—è¡¨, key=lambda x: x["æ—¶é—´æˆ³"], reverse=True)[:10]
        å¾…æ¸…è´¦æ•°é‡ = len([b for b in ç”¨æˆ·è´¦å•åˆ—è¡¨ if b["çŠ¶æ€"] == "å¾…æ¸…è´¦"])
        å·²æ¸…è´¦æ•°é‡ = len(ç”¨æˆ·è´¦å•åˆ—è¡¨) - å¾…æ¸…è´¦æ•°é‡

        # æ„å»ºå›å¤
        å›å¤å†…å®¹ = (
            f"ğŸ“Š æˆ‘çš„AAè´¦å•åˆ—è¡¨ï¼ˆå…±{len(ç”¨æˆ·è´¦å•åˆ—è¡¨)}æ¡ï¼Œæ˜¾ç¤ºæœ€è¿‘10æ¡ï¼‰\n"
            f"   ğŸ”´ å¾…æ¸…è´¦ï¼š{å¾…æ¸…è´¦æ•°é‡}æ¡ | ğŸŸ¢ å·²æ¸…è´¦ï¼š{å·²æ¸…è´¦æ•°é‡}æ¡\n"
            "-" * 50 + "\n"
        )
        for åºå·, è´¦å• in enumerate(æ’åºåçš„è´¦å•, 1):
            çŠ¶æ€æ ‡ç­¾ = "ğŸ”´ å¾…æ¸…è´¦" if è´¦å•["çŠ¶æ€"] == "å¾…æ¸…è´¦" else "ğŸŸ¢ å·²æ¸…è´¦"
            æ“ä½œæç¤º = f"æ“ä½œï¼š/æ ‡è®°æ¸…è´¦ {è´¦å•['è´¦å•ID']}" if è´¦å•["çŠ¶æ€"] == "å¾…æ¸…è´¦" else f"æ¸…è´¦æ—¶é—´ï¼š{è´¦å•['æ¸…è´¦æ—¶é—´']}"
            
            å›å¤å†…å®¹ += (
                f"{åºå·}. è´¦å•IDï¼š{è´¦å•['è´¦å•ID']} | {çŠ¶æ€æ ‡ç­¾}\n"
                f"   æè¿°ï¼š{è´¦å•['æ¶ˆè´¹æè¿°']}\n"
                f"   ä»˜æ¬¾äººï¼š{è´¦å•['ä»˜æ¬¾äºº']['åç§°']} | é‡‘é¢ï¼š{è´¦å•['æ€»é‡‘é¢']}å…ƒ\n"
                f"   å‚ä¸äººï¼š{', '.join(è´¦å•['å‚ä¸äºº'])}\n"
                f"   æ—¶é—´ï¼š{è´¦å•['åˆ›å»ºæ—¶é—´']}\n"
                f"   {æ“ä½œæç¤º}\n"
                "-" * 50 + "\n"
            )
        yield event.plain_result(å›å¤å†…å®¹)

    # ---------------------- æŒ‡ä»¤3ï¼šå¯¹è´¦æ˜ç»†ï¼ˆä¸­æ–‡æŒ‡ä»¤ï¼š/å¯¹è´¦æ˜ç»†ï¼‰ ----------------------
    @filter.command("å¯¹è´¦æ˜ç»†")
    async def å¯¹è´¦æ˜ç»†(self, event: AstrMessageEvent):
        """
        æŸ¥çœ‹æŒ‡å®šè´¦å•çš„å€ºåŠ¡æ˜ç»†
        ç”¨æ³•ï¼š/å¯¹è´¦æ˜ç»† [è´¦å•ID]
        ç¤ºä¾‹ï¼š/å¯¹è´¦æ˜ç»† abc123
        """
        æ¶ˆæ¯å†…å®¹ = event.message_str.strip()
        å‚æ•°åˆ—è¡¨ = list(filter(None, æ¶ˆæ¯å†…å®¹.split(" ")))[1:]

        if not å‚æ•°åˆ—è¡¨:
            yield event.plain_result(
                "âŒ ç¼ºå°‘è´¦å•IDï¼\n"
                "æ­£ç¡®ç”¨æ³•ï¼š/å¯¹è´¦æ˜ç»† [è´¦å•ID]\n"
                "ç¤ºä¾‹ï¼š/å¯¹è´¦æ˜ç»† abc123\n"
                "æç¤ºï¼šé€šè¿‡ /æŸ¥çœ‹è´¦å• å¯æŸ¥çœ‹æ‰€æœ‰è´¦å•ID"
            )
            return

        ç›®æ ‡è´¦å•ID = å‚æ•°åˆ—è¡¨[0]
        ç”¨æˆ·ID = event.get_sender_id()
        ç›®æ ‡è´¦å• = None

        # æŸ¥æ‰¾è´¦å•
        for è´¦å• in self.aa_bills.get(ç”¨æˆ·ID, []):
            if è´¦å•["è´¦å•ID"] == ç›®æ ‡è´¦å•ID:
                ç›®æ ‡è´¦å• = è´¦å•
                break

        if not ç›®æ ‡è´¦å•:
            yield event.plain_result(
                f"âŒ æœªæ‰¾åˆ°IDä¸ºã€Œ{ç›®æ ‡è´¦å•ID}ã€çš„è´¦å•\n"
                "ğŸ’¡ å¯èƒ½åŸå› ï¼š\n"
                "   1. è´¦å•IDè¾“å…¥é”™è¯¯ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰\n"
                "   2. è¯¥è´¦å•ä¸å±äºå½“å‰ç”¨æˆ·\n"
                "æç¤ºï¼šé€šè¿‡ /æŸ¥çœ‹è´¦å• æŸ¥çœ‹æ‰€æœ‰è´¦å•"
            )
            return

        # æ„å»ºå€ºåŠ¡æ˜ç»†å›å¤
        çŠ¶æ€æ ‡ç­¾ = "ğŸ”´ å¾…æ¸…è´¦" if ç›®æ ‡è´¦å•["çŠ¶æ€"] == "å¾…æ¸…è´¦" else "ğŸŸ¢ å·²æ¸…è´¦"
        å›å¤å†…å®¹ = (
            f"ğŸ“Š è´¦å•ã€Œ{ç›®æ ‡è´¦å•ID}ã€å€ºåŠ¡æ˜ç»† | {çŠ¶æ€æ ‡ç­¾}\n"
            "=" * 40 + "\n"
            f"ğŸ“ æè¿°ï¼š{ç›®æ ‡è´¦å•['æ¶ˆè´¹æè¿°']}\n"
            f"ğŸ’¸ ä»˜æ¬¾äººï¼š{ç›®æ ‡è´¦å•['ä»˜æ¬¾äºº']['åç§°']}ï¼ˆå«ä»˜{ç›®æ ‡è´¦å•['æ€»é‡‘é¢']}å…ƒï¼‰\n"
            f"ğŸ§® æ¯äººåˆ†æ‘Šï¼š{ç›®æ ‡è´¦å•['æ¯äººåˆ†æ‘Š']}å…ƒ\n"
            "\nã€å€ºåŠ¡å…³ç³»ã€‘\n"
        )

        å€ºåŠ¡åˆ—è¡¨ = ç›®æ ‡è´¦å•["å€ºåŠ¡å…³ç³»"]
        if not å€ºåŠ¡åˆ—è¡¨:
            å›å¤å†…å®¹ += "âš ï¸  æ— å€ºåŠ¡å…³ç³»ï¼ˆä»…ä»˜æ¬¾äººä¸€äººå‚ä¸ï¼‰\n"
        else:
            for å€ºåŠ¡ in å€ºåŠ¡åˆ—è¡¨:
                å›å¤å†…å®¹ += f"ğŸ‘‰ {å€ºåŠ¡['å€ºåŠ¡äºº']} åº”æ”¯ä»˜ {å€ºåŠ¡['å€ºæƒäºº']} {å€ºåŠ¡['é‡‘é¢']}å…ƒ\n"

        if ç›®æ ‡è´¦å•["åˆ†è´¦è¯¯å·®"] > 0:
            å›å¤å†…å®¹ += (
                f"\nâš ï¸  è¯¯å·®è¯´æ˜ï¼š\n"
                f"{ç›®æ ‡è´¦å•['ä»˜æ¬¾äºº']['åç§°']}å¤šæ‰¿æ‹…{ç›®æ ‡è´¦å•['åˆ†è´¦è¯¯å·®']}å…ƒï¼ˆæ€»é‡‘é¢æ— æ³•å‡åˆ†ï¼‰\n"
            )

        if ç›®æ ‡è´¦å•["çŠ¶æ€"] == "å¾…æ¸…è´¦":
            å›å¤å†…å®¹ += f"\nğŸ’¡ æç¤ºï¼šæ‰€æœ‰å€ºåŠ¡ç»“æ¸…åï¼Œæ‰§è¡Œ /æ ‡è®°æ¸…è´¦ {ç›®æ ‡è´¦å•ID} æ ‡è®°æ¸…è´¦\n"
        else:
            å›å¤å†…å®¹ += f"\nâœ… å·²æ¸…è´¦ï¼š{ç›®æ ‡è´¦å•['æ¸…è´¦æ—¶é—´']}ï¼ˆ{ç›®æ ‡è´¦å•['æ¸…è´¦äºº']['åç§°']}æ“ä½œï¼‰\n"

        yield event.plain_result(å›å¤å†…å®¹)

    # ---------------------- æŒ‡ä»¤4ï¼šæ ‡è®°æ¸…è´¦ï¼ˆä¸­æ–‡æŒ‡ä»¤ï¼š/æ ‡è®°æ¸…è´¦ï¼‰ ----------------------
    @filter.command("æ ‡è®°æ¸…è´¦")
    async def æ ‡è®°æ¸…è´¦(self, event: AstrMessageEvent):
        """
        å°†æŒ‡å®šè´¦å•æ ‡è®°ä¸ºå·²æ¸…è´¦
        ç”¨æ³•ï¼š/æ ‡è®°æ¸…è´¦ [è´¦å•ID]
        ç¤ºä¾‹ï¼š/æ ‡è®°æ¸…è´¦ abc123
        """
        æ¶ˆæ¯å†…å®¹ = event.message_str.strip()
        å‚æ•°åˆ—è¡¨ = list(filter(None, æ¶ˆæ¯å†…å®¹.split(" ")))[1:]

        if not å‚æ•°åˆ—è¡¨:
            yield event.plain_result(
                "âŒ ç¼ºå°‘è´¦å•IDï¼\n"
                "æ­£ç¡®ç”¨æ³•ï¼š/æ ‡è®°æ¸…è´¦ [è´¦å•ID]\n"
                "ç¤ºä¾‹ï¼š/æ ‡è®°æ¸…è´¦ abc123\n"
                "æç¤ºï¼šé€šè¿‡ /æŸ¥çœ‹è´¦å• å¯æŸ¥çœ‹æ‰€æœ‰è´¦å•ID"
            )
            return

        ç›®æ ‡è´¦å•ID = å‚æ•°åˆ—è¡¨[0]
        ç”¨æˆ·ID = event.get_sender_id()
        æ¸…è´¦äººåç§° = event.get_sender_name() or f"ç”¨æˆ·{ç”¨æˆ·ID[:4]}"
        æ¸…è´¦æ—¶é—´ = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        ç›®æ ‡è´¦å• = None

        # æŸ¥æ‰¾è´¦å•
        for è´¦å• in self.aa_bills.get(ç”¨æˆ·ID, []):
            if è´¦å•["è´¦å•ID"] == ç›®æ ‡è´¦å•ID:
                ç›®æ ‡è´¦å• = è´¦å•
                break

        if not ç›®æ ‡è´¦å•:
            yield event.plain_result(
                f"âŒ æœªæ‰¾åˆ°IDä¸ºã€Œ{ç›®æ ‡è´¦å•ID}ã€çš„è´¦å•\n"
                "æç¤ºï¼šé€šè¿‡ /æŸ¥çœ‹è´¦å• æŸ¥çœ‹æ‰€æœ‰è´¦å•"
            )
            return

        # å·²æ¸…è´¦å¤„ç†
        if ç›®æ ‡è´¦å•["çŠ¶æ€"] == "å·²æ¸…è´¦":
            yield event.plain_result(
                f"âœ… è´¦å•ã€Œ{ç›®æ ‡è´¦å•ID}ã€å·²æ˜¯å·²æ¸…è´¦çŠ¶æ€\n"
                "=" * 30 + "\n"
                f"æ¸…è´¦æ—¶é—´ï¼š{ç›®æ ‡è´¦å•['æ¸…è´¦æ—¶é—´']}\n"
                f"æ¸…è´¦äººï¼š{ç›®æ ‡è´¦å•['æ¸…è´¦äºº']['åç§°']}\n"
                "=" * 30
            )
            return

        # æ›´æ–°è´¦å•çŠ¶æ€
        ç›®æ ‡è´¦å•["çŠ¶æ€"] = "å·²æ¸…è´¦"
        ç›®æ ‡è´¦å•["æ¸…è´¦æ—¶é—´"] = æ¸…è´¦æ—¶é—´
        ç›®æ ‡è´¦å•["æ¸…è´¦äºº"] = {"ID": ç”¨æˆ·ID, "åç§°": æ¸…è´¦äººåç§°}

        # è®°å½•æ¸…è´¦è®°å½•
        self.settlement_records.setdefault(ç”¨æˆ·ID, []).append({
            "è®°å½•ID": str(uuid.uuid4())[:8],
            "è´¦å•ID": ç›®æ ‡è´¦å•ID,
            "æ¶ˆè´¹æè¿°": ç›®æ ‡è´¦å•["æ¶ˆè´¹æè¿°"],
            "æ€»é‡‘é¢": ç›®æ ‡è´¦å•["æ€»é‡‘é¢"],
            "æ¸…è´¦äºº": æ¸…è´¦äººåç§°,
            "æ¸…è´¦æ—¶é—´": æ¸…è´¦æ—¶é—´,
            "æ—¶é—´æˆ³": int(time.time())
        })

        # ä¿å­˜æ•°æ®
        self._ä¿å­˜æ•°æ®()

        # ç”Ÿæˆå›å¤
        å›å¤å†…å®¹ = (
            f"âœ… è´¦å•ã€Œ{ç›®æ ‡è´¦å•ID}ã€å·²æ ‡è®°ä¸ºå·²æ¸…è´¦ï¼\n"
            "=" * 40 + "\n"
            f"ğŸ“ æè¿°ï¼š{ç›®æ ‡è´¦å•['æ¶ˆè´¹æè¿°']}\n"
            f"ğŸ’° é‡‘é¢ï¼š{ç›®æ ‡è´¦å•['æ€»é‡‘é¢']}å…ƒ\n"
            f"â° æ¸…è´¦æ—¶é—´ï¼š{æ¸…è´¦æ—¶é—´}\n"
            f"ğŸ§‘ æ¸…è´¦äººï¼š{æ¸…è´¦äººåç§°}\n"
            "=" * 40
        )
        yield event.plain_result(å›å¤å†…å®¹)

    # ---------------------- æŒ‡ä»¤5ï¼šå¸®åŠ©ä¸­å¿ƒï¼ˆä¸­æ–‡æŒ‡ä»¤ï¼š/å¸®åŠ©ä¸­å¿ƒï¼‰ ----------------------
    @filter.command("å¸®åŠ©ä¸­å¿ƒ")
    async def å¸®åŠ©ä¸­å¿ƒ(self, event: AstrMessageEvent):
        """
        æŸ¥çœ‹AAåˆ†è´¦ç³»ç»Ÿçš„æ‰€æœ‰æŒ‡ä»¤å¸®åŠ©
        ç”¨æ³•ï¼š/å¸®åŠ©ä¸­å¿ƒ
        """
        å¸®åŠ©æ–‡æœ¬ = (
            "ğŸ“Š AAåˆ†è´¦ç³»ç»Ÿå¸®åŠ©ä¸­å¿ƒï¼ˆv1.0.1ï¼‰\n"
            "=" * 45 + "\n"
            "ã€æ‰€æœ‰å¯ç”¨æŒ‡ä»¤ã€‘\n"
            "\n"
            "1. åˆ›å»ºAAè´¦å•\n"
            "   ğŸ“Œ æŒ‡ä»¤ï¼š/åˆ›å»ºè´¦å• [å‚ä¸äºº1] [å‚ä¸äºº2] ... [é‡‘é¢] [æè¿°å¯é€‰]\n"
            "   ğŸ“Œ ç¤ºä¾‹ï¼š/åˆ›å»ºè´¦å• é™ˆ 100ï¼ˆç®€å•æ¨¡å¼ï¼‰\n"
            "   ğŸ“Œ ç¤ºä¾‹ï¼š/åˆ›å»ºè´¦å• å¼ ä¸‰ æå›› 600 èšé¤ï¼ˆå®Œæ•´æ¨¡å¼ï¼‰\n"
            "   ğŸ“Œ åŠŸèƒ½ï¼šåˆ›å»ºè´¦å•ï¼Œè‡ªåŠ¨è®¡ç®—æ¯äººåˆ†æ‘Šé‡‘é¢\n"
            "\n"
            "2. æŸ¥çœ‹æ‰€æœ‰è´¦å•\n"
            "   ğŸ“Œ æŒ‡ä»¤ï¼š/æŸ¥çœ‹è´¦å•\n"
            "   ğŸ“Œ åŠŸèƒ½ï¼šæŒ‰æ—¶é—´å€’åºæ˜¾ç¤ºæ‰€æœ‰è´¦å•ï¼ŒåŒºåˆ†å¾…æ¸…è´¦/å·²æ¸…è´¦\n"
            "\n"
            "3. æŸ¥çœ‹å€ºåŠ¡æ˜ç»†\n"
            "   ğŸ“Œ æŒ‡ä»¤ï¼š/å¯¹è´¦æ˜ç»† [è´¦å•ID]\n"
            "   ğŸ“Œ ç¤ºä¾‹ï¼š/å¯¹è´¦æ˜ç»† abc123\n"
            "   ğŸ“Œ åŠŸèƒ½ï¼šæ˜¾ç¤ºæŒ‡å®šè´¦å•çš„å€ºåŠ¡å…³ç³»ï¼ˆè°è¯¥ç»™è°é’±ï¼‰\n"
            "\n"
            "4. æ ‡è®°è´¦å•æ¸…è´¦\n"
            "   ğŸ“Œ æŒ‡ä»¤ï¼š/æ ‡è®°æ¸…è´¦ [è´¦å•ID]\n"
            "   ğŸ“Œ ç¤ºä¾‹ï¼š/æ ‡è®°æ¸…è´¦ abc123\n"
            "   ğŸ“Œ åŠŸèƒ½ï¼šå°†è´¦å•æ ‡è®°ä¸ºå·²æ¸…è´¦ï¼Œè®°å½•æ¸…è´¦äºº/æ—¶é—´\n"
            "\n"
            "5. æŸ¥çœ‹å¸®åŠ©\n"
            "   ğŸ“Œ æŒ‡ä»¤ï¼š/å¸®åŠ©ä¸­å¿ƒ\n"
            "   ğŸ“Œ åŠŸèƒ½ï¼šæ˜¾ç¤ºæœ¬å¸®åŠ©ä¸­å¿ƒ\n"
            "=" * 45 + "\n"
            "ğŸ“¢ æç¤ºï¼šè´¦å•æ•°æ®æŒ‰ç”¨æˆ·éš”ç¦»ï¼Œä»…è‡ªå·±å¯è§"
        )
        yield event.plain_result(å¸®åŠ©æ–‡æœ¬)

    # ---------------------- è¾…åŠ©æ–¹æ³• ----------------------
    def _ç”Ÿæˆå€ºåŠ¡å…³ç³»(self, ä»˜æ¬¾äºº: str, å‚ä¸äººåˆ—è¡¨: List[str], é‡‘é¢: float) -> List[Dict]:
        """ç”Ÿæˆå€ºåŠ¡å…³ç³»åˆ—è¡¨ï¼šå‚ä¸äººå‘ä»˜æ¬¾äººæ”¯ä»˜åˆ†æ‘Šé‡‘é¢"""
        return [
            {"å€ºåŠ¡äºº": äººå‘˜, "å€ºæƒäºº": ä»˜æ¬¾äºº, "é‡‘é¢": é‡‘é¢}
            for äººå‘˜ in å‚ä¸äººåˆ—è¡¨ if äººå‘˜ != ä»˜æ¬¾äºº
        ]

    def _åŠ è½½å†å²æ•°æ®(self):
        """åŠ è½½å†å²æ•°æ®ï¼ˆä»JSONæ–‡ä»¶è¯»å–ï¼‰"""
        # åŠ è½½è´¦å•æ•°æ®
        try:
            if os.path.exists(self.bills_path):
                with open(self.bills_path, "r", encoding="utf-8") as f:
                    self.aa_bills = json.load(f)
                logger.info(f"AAåˆ†è´¦ç³»ç»Ÿï¼šæˆåŠŸåŠ è½½{len(self.aa_bills)}ä¸ªç”¨æˆ·çš„è´¦å•æ•°æ®")
            else:
                logger.info("AAåˆ†è´¦ç³»ç»Ÿï¼šè´¦å•æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ç©ºæ•°æ®")
        except Exception as e:
            logger.error(f"AAåˆ†è´¦ç³»ç»Ÿï¼šåŠ è½½è´¦å•æ•°æ®å¤±è´¥ï¼š{str(e)}ï¼Œåˆå§‹åŒ–ç©ºæ•°æ®")
            self.aa_bills = {}

        # åŠ è½½æ¸…è´¦è®°å½•
        try:
            if os.path.exists(self.records_path):
                with open(self.records_path, "r", encoding="utf-8") as f:
                    self.settlement_records = json.load(f)
                logger.info(f"AAåˆ†è´¦ç³»ç»Ÿï¼šæˆåŠŸåŠ è½½{len(self.settlement_records)}ä¸ªç”¨æˆ·çš„æ¸…è´¦è®°å½•")
            else:
                logger.info("AAåˆ†è´¦ç³»ç»Ÿï¼šæ¸…è´¦è®°å½•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ç©ºæ•°æ®")
        except Exception as e:
            logger.error(f"AAåˆ†è´¦ç³»ç»Ÿï¼šåŠ è½½æ¸…è´¦è®°å½•å¤±è´¥ï¼š{str(e)}ï¼Œåˆå§‹åŒ–ç©ºæ•°æ®")
            self.settlement_records = {}

    def _ä¿å­˜æ•°æ®(self):
        """ä¿å­˜æ•°æ®åˆ°JSONæ–‡ä»¶ï¼ˆæŒä¹…åŒ–ï¼‰"""
        # ä¿å­˜è´¦å•æ•°æ®
        try:
            with open(self.bills_path, "w", encoding="utf-8") as f:
                json.dump(self.aa_bills, f, ensure_ascii=False, indent=2)
            logger.info("AAåˆ†è´¦ç³»ç»Ÿï¼šè´¦å•æ•°æ®ä¿å­˜æˆåŠŸ")
        except Exception as e:
            logger.error(f"AAåˆ†è´¦ç³»ç»Ÿï¼šä¿å­˜è´¦å•æ•°æ®å¤±è´¥ï¼š{str(e)}")

        # ä¿å­˜æ¸…è´¦è®°å½•
        try:
            with open(self.records_path, "w", encoding="utf-8") as f:
                json.dump(self.settlement_records, f, ensure_ascii=False, indent=2)
            logger.info("AAåˆ†è´¦ç³»ç»Ÿï¼šæ¸…è´¦è®°å½•ä¿å­˜æˆåŠŸ")
        except Exception as e:
            logger.error(f"AAåˆ†è´¦ç³»ç»Ÿï¼šä¿å­˜æ¸…è´¦è®°å½•å¤±è´¥ï¼š{str(e)}")

    async def terminate(self):
        """æ’ä»¶å¸è½½/åœç”¨æ—¶è°ƒç”¨ï¼Œç¡®ä¿æ•°æ®ä¿å­˜"""
        self._ä¿å­˜æ•°æ®()
        logger.info("AAåˆ†è´¦ç³»ç»Ÿæ’ä»¶å·²å¸è½½ï¼Œæ‰€æœ‰æ•°æ®å·²æŒä¹…åŒ–ä¿å­˜")
